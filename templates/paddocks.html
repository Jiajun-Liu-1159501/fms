{% extends "base.html" %}

{% block title %}FMS Paddocks{% endblock %}

{% block content %}

    <div class="container">
        
        <div class="d-flex align-items-center mb-3 mt-3">
            <p>Current location:&nbsp;&nbsp;</p>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a class="text-success" href="{{url_for('home')}}">Home</a></li>
                <li class="breadcrumb-item"><a class="text-success" href="{{url_for('paddocks')}}">Paddocks</a></li>
              </ol>
            </nav>
        </div>
        
        <h4 class="mb-3">Paddock List:</h4>
        
        <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target="#table_collapse" aria-expanded="false" aria-controls="table_collapse" onclick="this.innerHTML = this.getAttribute('aria-expanded') === 'false' ? 'Expand' : 'Collapse'">
            Collapse
        </button>
        
        <table class="table" style="table-layout: fixed;">
            <thead>
                <tr>
                    <th scope="col" style="width: 12%;">Paddock ID</th>
                    <th scope="col" style="width: 12%;">Paddock Nameâ†‘</th>
                    <th scope="col" style="width: 12%;">Paddock Area</th>
                    <th scope="col" style="width: 12%;">DM per HA</th>
                    <th scope="col" style="width: 12%;">Total DM</th>
                    <th scope="col" style="width: 12%;">Mob Name</th>
                    <th scope="col" style="width: 12%;">Total Stock</th>
                    <th scope="col">Options</th>
                </tr>
            </thead>
            <tbody class="collapse show", id="table_collapse">
            {% for paddock in data['paddocks'] %}
                {% if paddock['dm_per_ha'] <= 1500 %}  
                    <tr class="table-danger">
                {% elif paddock['dm_per_ha'] <= 1800 %}
                    <tr class="table-warning">
                {% else %}
                    <tr>
                {% endif %}
                        <td scope="row">{{paddock['id']}}</td>  
                        <td scope="row">{{paddock['name']}}</td>
                        <td scope="row">{{paddock['area']}}</td>
                        <td scope="row" >{{paddock['dm_per_ha']}}</td>
                        <td scope="row">{{paddock['total_dm']}}</td>
                        <td scope="row">{{paddock['mob_name'] if paddock['mob_name'] else ''}}</td>   
                        <td scope="row">{{paddock['sotck_num']}}</td>
                        <td scope="row" class="bg-transparent">
                            <button type="button" class="btn btn-warning edit_button">Edit</button>
                            <button type="button" class="btn btn-info {{'d-none' if paddock['mob_name'] else ''}}" onclick="handle_move_in(this)">Move In</button>
                            <button type="button" class="btn btn-danger d-none" onclick="cancel_move(this)">Cancel Move</button>
                            <button type="button" class="btn btn-info d-none move_out_button" data-can-move-out="{{'true' if paddock['mob_name'] else 'false'}}" onclick="handle_move_out(this)">Move Out</button>
                        </td>
                    </tr>
            {% endfor %}

            </tbody>    
        </table>

        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered w-auto">
                <div class="modal-content">
                    <form id="moveForm" action="/move" method="POST">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="staticBackdropLabel">Paddock Movement Confirmation</h1>
                        </div>
                        <div class="modal-body">
                            <div class="row align-items-center justify-content-center">
                                <div class="col-sm-5 mb-3 mb-sm-0">
                                    <div class="card text-bg-success">
                                        <div class="card-body">
                                            <h5 class="card-title" id="out-paddock-name"></h5>
                                            <p class="card-text"> Area: <span class="card-text" id="out-paddock-area" style="text-decoration: underline; font-style: italic;"></span></p>
                                            <p class="card-text"> Total DM: <span class="card-text" id="out-paddock-total" style="text-decoration: underline; font-style: italic;"></span></p>
                                            <p class="card-text">Mob: <span class="card-text" id="out-mob-name" style="text-decoration: underline; font-style: italic;"></span></p>
                                            <p class="card-text">Stocks: <span class="card-text" id="out-stocks" style="text-decoration: underline; font-style: italic;"></span></p>
                                            <input type="hidden" name="source_id" class="card-text" id="out-paddock-id">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-1 mb-3 mb-sm-0">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <span class="mx-2">&#8594;</span>
                                    </div>
                                </div>
                                <div class="col-sm-5 mb-3 mb-sm-0">
                                    <div class="card text-bg-success">
                                        <div class="card-body">
                                            <h5 class="card-title" id="in-paddock-name"></h5>
                                            <p class="card-text"> Area: <span class="card-text" id="in-paddock-area" style="text-decoration: underline; font-style: italic;"></span></p>
                                            <p class="card-text"> Total DM: <span class="card-text" id="in-paddock-total" style="text-decoration: underline; font-style: italic;"></span></p>
                                            <p class="card-text"><span class="card-text" id="in-mob-name" style="text-decoration: underline; font-style: italic;">&nbsp;</span></p>
                                            <p class="card-text"><span class="card-text" id="in-stocks" style="text-decoration: underline; font-style: italic;">&nbsp;</span></p>
                                            <input type="hidden" name="target_id" class="card-text" id="in-paddock-id">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-info">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <script>

            let selectedRows = new Map();
            let target_row = null;

            function handle_move_in(button) {
                const row = button.closest('tr');
                const buttons = row.querySelectorAll('button');
                document.querySelectorAll('.edit_button').forEach(btn => btn.disabled = true)    //disable all edit button
                buttons[1].classList.add('d-none');     //hide current move in button
                buttons[2].classList.remove('d-none');     //show move cancel button
                document.querySelectorAll('.move_out_button').forEach(btn => {
                    if (btn.getAttribute('data-can-move-out') == 'true') {
                        btn.classList.remove('d-none')
                    }
                })
                selectedRows.set('in', build_data_map(row));
                target_row = row;
            }

            function handle_move_out(button) {
                const row = button.closest('tr');
                selectedRows.set('out', build_data_map(row));
                
                document.getElementById('out-paddock-name').innerText = selectedRows.get('out').get('paddock_name')
                document.getElementById('out-paddock-id').value = selectedRows.get('out').get('paddock_id')
                document.getElementById('out-paddock-area').innerText = selectedRows.get('out').get('paddock_area')
                document.getElementById('out-paddock-total').innerText = selectedRows.get('out').get('paddock_total')
                document.getElementById('out-mob-name').innerText = selectedRows.get('out').get('mob_name')
                document.getElementById('out-stocks').innerText = selectedRows.get('out').get('mob_stock')

                document.getElementById('in-paddock-name').innerText = selectedRows.get('in').get('paddock_name')
                document.getElementById('in-paddock-id').value = selectedRows.get('in').get('paddock_id')
                document.getElementById('in-paddock-area').innerText = selectedRows.get('in').get('paddock_area')
                document.getElementById('in-paddock-total').innerText = selectedRows.get('in').get('paddock_total')

                const modal = new bootstrap.Modal(document.getElementById('staticBackdrop'));
                modal.show();
                reset_buttons(target_row)
            }

            function cancel_move(button) {
                reset_buttons(target_row)
                selectedRows = new Map();
            }

            function reset_buttons(row) {
                const buttons = row.querySelectorAll('button');
                document.querySelectorAll('.edit_button').forEach(btn => btn.disabled = false)    //enable all edit button
                buttons[1].classList.remove('d-none');     //hide current move in button
                buttons[2].classList.add('d-none');     //show move cancel button
                document.querySelectorAll('.move_out_button').forEach(btn => {
                    if (btn.getAttribute('data-can-move-out') == 'true') {
                        btn.classList.add('d-none')
                    }
                })
            }

            function build_data_map(row) {
                let target_map = new Map();
                target_map.set('paddock_id', row.cells[0].innerText)
                target_map.set('paddock_name', row.cells[1].innerText)
                target_map.set('paddock_area', row.cells[2].innerText)
                target_map.set('paddock_total', row.cells[4].innerText)
                target_map.set('mob_name', row.cells[5].innerText)
                target_map.set('mob_stock', row.cells[6].innerText)
                return target_map;
            }

        </script>

    </div>

{% endblock %}